var pagina_siguiente,pagina_anterior,html_siguiente,paginaActual=1,folioBusqueda="",fechaBusqueda="",subclasificacionBusqueda="",atiendeBusqueda="",estadoBusqueda="";const btnSiguiente=document.querySelector("#btnSiguiente"),btnAnterior=document.querySelector("#btnAnterior");var folioModal,total_registros_anterior=0;function modal(){document.querySelectorAll(".btnFolio").forEach(e=>{e.addEventListener("click",(function(e){abrirModal(folioModal=parseInt(e.target.dataset.folio))}))})}function prueba(){}limpiarNotificaciones(),busqueda(),document.addEventListener("DOMContentLoaded",(function(){llenarTablaTickets(paginaActual,folioBusqueda),btnSiguiente.addEventListener("click",(function(){paginaActual<pagina_siguiente&&paginaActual++,llenarTablaTickets(paginaActual,folioBusqueda)})),btnAnterior.addEventListener("click",(function(){paginaActual>=pagina_anterior&&paginaActual--,llenarTablaTickets(paginaActual,folioBusqueda)}))}));const folio=document.querySelector("#idFolio"),atiende=document.querySelector("#idAtiende"),fecha=document.querySelector("#idFecha"),requiere=document.querySelector("#idRequiere"),estado=document.querySelector("#idEstado"),clasificacion=document.querySelector("#idClasificacion"),subclasificacion=document.querySelector("#idSubclasificacion"),comentarios=document.querySelector("#idComentarios"),comentariosSoporte=document.querySelector("#idComentariosSoporte");async function limpiarNotificaciones(){try{const e="/api/limpiarNotificaciones";await fetch(e)}catch(e){console.log(e)}}function mostrarMesEnCurso(){var e=(new Date).getMonth()+1;const t=document.querySelector("#idFecha");t.addEventListener(),t.value=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][e-1]}function busqueda(){const e=document.querySelector("#folioBusqueda");e.addEventListener("keyup",(function(){folioBusqueda=e.value,llenarTablaTickets(paginaActual=1,folioBusqueda)}))}async function llenarTablaTickets(e,t){const a=document.querySelector(".tabla__body.tickets"),i=document.querySelector("#paginas");try{const n="/api/obtenerTablaTickets?page="+e+"&folio="+t,o=await fetch(n),c=await o.json(),r=c.tablaRows,s=c.total_registros,l=c.total_paginas,d=document.querySelector(".paginacion");d.style.visibility=0===l||1===l?"hidden":"visible";const u=c.idRol,b=c.nombreLogueado;pagina_siguiente=c.pagina_siguiente,pagina_anterior=c.pagina_anterior,html_siguiente=c.html_siguiente,s>total_registros_anterior&&(total_registros_anterior=s,paginaActual=1),a.innerHTML="",r.forEach(e=>{const t=document.createElement("tr"),n=document.createElement("td"),o=document.createElement("button"),c=document.createElement("td"),r=document.createElement("td"),s=document.createElement("td"),d=document.createElement("td"),p=document.createElement("td"),m=document.createElement("td"),f=document.createElement("td"),g=document.createElement("td"),y=document.createElement("td"),h=document.createElement("DIV"),{idTicket:q,fechaCaptura:_,atiende:L,nombreRequiere:S,estadoTicket:k,clasificacion:A,subclasificacion:T,comentarios:v,comentariosSoporte:E}=e;o.textContent=q,o.setAttribute("value",q),o.setAttribute("data-folio",q),o.setAttribute("data-bs-toggle","modal"),o.setAttribute("data-bs-target","#infoModal"),c.textContent=_.split("-")[2]+"/"+_.split("-")[1]+"/"+_.split("-")[0],r.textContent=L,s.textContent=S,d.textContent=k,p.textContent=A,m.textContent=T,f.textContent=v,g.textContent=E,n.classList.add("text-center"),o.classList.add("btn","btn-dark","text-center","btnFolio","fs-4"),c.classList.add("tabla__td","text-center"),r.classList.add("tabla__td","text-center"),s.classList.add("tabla__td","text-center"),d.classList.add("tabla__td","text-center"),p.classList.add("tabla__td","text-center"),m.classList.add("tabla__td","text-center"),f.classList.add("tabla__td","text-center"),g.classList.add("tabla__td","text-center"),y.classList.add("tabla__td","text-center"),"Abierto"===k&&d.classList.add("estado-abierto"),"Pausado"===k&&d.classList.add("estado-pausado"),"Escalado"===k&&d.classList.add("estado-escalado"),"Cerrado"===k&&d.classList.add("estado-cerrado"),h.classList.add("container","d-flex","gap-2"),"4"===u&&h.classList.add("container","d-flex","gap-2"),h.innerHTML="<a href='/dashboard/historial-tickets?id="+q+"' title='Historial del ticket' class='fs-2 btn btn-primary btn-sm'><i class='bi bi-calendar2-week'></i></a>","2"===u&&("Abierto"===k||"Pausado"===k||"Escalado"===k?("Sin asignar"===L&&(h.innerHTML+="<a href='/dashboard/asignar-tickets?id="+q+"' title='Asignar ticket' class='fs-2 btn btn-info btn-sm'><i class='bi bi-box-arrow-in-right'></i></i></a>"),"Sin asignar"!==L&&(h.innerHTML+="<a href='/dashboard/pausar-tickets?id="+q+"' title='Pausar ticket' class='fs-2 btn btn-secondary btn-sm'><i class='bi bi-pause-circle'></i></a>",h.innerHTML+="<a href='/dashboard/escalar-tickets?id="+q+"' title='Escalar ticket' class='fs-2 btn btn-warning btn-sm'><i class='bi bi-bezier2'></i></a>",h.innerHTML+="<a href='/dashboard/cerrar-tickets?id="+q+"' title='Cerrar ticket' class='fs-2 btn btn-success btn-sm'><i class='bi bi-check2-circle'></i></a>")):h.innerHTML+="<p class='tabla__cerrado'>Ticket cerrado</p>"),"1"!==u&&"3"!==u||("Abierto"===k||"Pausado"===k||"Escalado"===k?"Sin asignar"!==L&&L===b&&(h.innerHTML+="<a href='/dashboard/pausar-tickets?id="+q+"' title='Pausar ticket' class='fs-2 btn btn-secondary btn-sm'><i class='bi bi-pause-circle'></i></a>","1"===u&&(h.innerHTML+="<a href='/dashboard/escalar-tickets?id="+q+"' title='Escalar ticket' class='fs-2 btn btn-warning btn-sm'><i class='bi bi-bezier2'></i></a>"),h.innerHTML+="<a href='/dashboard/cerrar-tickets?id="+q+"' title='Cerrar ticket' class='fs-2 btn btn-success btn-sm'><i class='bi bi-check2-circle'></i></a>"):h.innerHTML+="<p class='tabla__cerrado'>Ticket cerrado</p>"),"4"===u&&"Cerrado"===k&&(h.innerHTML+="<p class='tabla__cerrado'>Ticket cerrado</p>"),n.appendChild(o),t.appendChild(n),t.appendChild(c),t.appendChild(r),t.appendChild(s),t.appendChild(d),t.appendChild(p),t.appendChild(m),t.appendChild(f),t.appendChild(g),y.appendChild(h),t.appendChild(y),a.appendChild(t),btnSiguiente.disabled=!pagina_siguiente,btnAnterior.disabled=!pagina_anterior;var C="";var x=1,M=l;if(l>5)if(paginaActual<=5)x=1,M=5;else if(paginaActual+2===l||paginaActual+2>l)x=l-4,M=l;else x=paginaActual-2,M=paginaActual+2;for(var H=x;H<=M;H++)C+=' <button  class="btn btn-outline-primary fs-3 botonPaginas" data-pagina ='+H+">"+H+" </button>";i.innerHTML=C;document.querySelectorAll(".botonPaginas").forEach(e=>{e.addEventListener("click",(function(e){pagina=parseInt(e.target.dataset.pagina),llenarTablaTickets(paginaActual=pagina,folioBusqueda)})),parseInt(e.dataset.pagina)===parseInt(paginaActual)?(e.classList.remove("btn-outline-primary"),e.classList.add("btn-primary")):(e.classList.add("btn-outline-primary"),e.classList.remove("btn-primary"))})}),modal()}catch(e){console.log(e)}}function fadeOutAlerta(){$(".div-ver-tickets").fadeOut(1e3)}function paginas(){document.querySelectorAll(".botonPaginas").forEach(e=>{e.addEventListener("click",(function(e){console.log("memo")}))})}async function abrirModal(e){let t=document.querySelector("#infoModal");try{const a="/api/modal?folio="+e,i=await fetch(a),n=(await i.json()).infoTicket;console.log(n),t.addEventListener("shown.bs.modal",e=>{let a=t.querySelector(".modal-body #folio"),i=t.querySelector(".modal-body #requiere"),o=t.querySelector(".modal-body #departamento"),c=t.querySelector(".modal-body #extension"),r=t.querySelector(".modal-body #email"),s=t.querySelector(".modal-body #clasificacion"),l=t.querySelector(".modal-body #subclasificacion"),d=t.querySelector(".modal-body #comentariosReporte"),u=t.querySelector(".modal-body #comentariosSoporte"),b=t.querySelector(".modal-body #atiende");a.value=n.idTicket,i.value=n.nombreRequiere,o.value=n.departamento,c.value=n.extension,r.value=n.email,s.value=n.clasificacion,l.value=n.subclasificacion,d.value=n.comentariosReporte,u.value=n.comentariosSoporte,b.value=n.atiende})}catch(e){console.log(e)}}setInterval((function(){llenarTablaTickets(paginaActual,folioBusqueda)}),2e3),setTimeout((function(){fadeOutAlerta()}),2e3);