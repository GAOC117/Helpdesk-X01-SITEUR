var expedienteLogueado,pagina_siguiente,pagina_anterior,html_siguiente,paginaActual=1,folioBusqueda="",fechaBusqueda="",clasificacionBusqueda="",subclasificacionBusqueda="",atiendeBusqueda="",requiereBusqueda="",estadoBusqueda="",servicioBusqueda="",rangoChecked=!1;const btnSiguiente=document.querySelector("#btnSiguiente"),btnAnterior=document.querySelector("#btnAnterior"),rangoCheck=document.querySelector("#checkFechas"),limpiarFiltros=document.querySelector("#limpiarFiltros"),excel=document.querySelector("#exportarExcel");excel.addEventListener("click",(function(){exportarExcel(folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),rangoCheck.addEventListener("change",(function(){rangoChecked=!!rangoCheck.checked,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)}));var folioModal,total_registros_anterior=0;function modal(){document.querySelectorAll(".btnFolio").forEach(e=>{e.addEventListener("click",(function(e){abrirModal(folioModal=parseInt(e.target.dataset.folio))}))})}function prueba(){}limpiarNotificaciones(),busqueda(),document.addEventListener("DOMContentLoaded",(function(){var e=new Date,a=e.toLocaleString("default",{year:"numeric"})+"-"+e.toLocaleString("default",{month:"2-digit"})+"-"+e.toLocaleString("default",{day:"2-digit"});const t=document.querySelector("#fechaDesde"),i=document.querySelector("#fechaHasta");t.value=a,i.value=a,t.addEventListener("change",(function(){llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda)})),i.addEventListener("change",(function(){llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda)})),limpiarFiltros.addEventListener("click",(function(){const e=document.querySelector("#folioBusqueda"),u=document.querySelector("#fechaBusqueda"),c=document.querySelector("#atiendeBusqueda"),s=document.querySelector("#requiereBusqueda"),o=document.querySelector("#estadoBusqueda"),n=document.querySelector("#clasificacionBusqueda"),d=document.querySelector("#subclasificacionBusqueda"),r=document.querySelector("#servicioBusqueda");e.value="",u.value="",c.value="",s.value="",o.value="",n.value="",d.value="",t.value=a,i.value=a,rangoCheck.checked=!1,r.value="",servicioBusqueda="",llenarTablaTickets(paginaActual=1,folioBusqueda="",fechaBusqueda="",atiendeBusqueda="",requiereBusqueda="",estadoBusqueda="",clasificacionBusqueda="",subclasificacionBusqueda="",rangoChecked=!1,t.value,i.value,servicioBusqueda)})),llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda),btnSiguiente.addEventListener("click",(function(){paginaActual<pagina_siguiente&&paginaActual++,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda)})),btnAnterior.addEventListener("click",(function(){paginaActual>=pagina_anterior&&paginaActual--,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda)}))}));const folio=document.querySelector("#idFolio"),atiende=document.querySelector("#idAtiende"),fecha=document.querySelector("#idFecha"),requiere=document.querySelector("#idRequiere"),estado=document.querySelector("#idEstado"),clasificacion=document.querySelector("#idClasificacion"),subclasificacion=document.querySelector("#idSubclasificacion"),comentarios=document.querySelector("#idComentarios"),comentariosSoporte=document.querySelector("#idComentariosSoporte");async function limpiarNotificaciones(){try{const e="/api/limpiarNotificaciones";await fetch(e)}catch(e){console.log(e)}}function mostrarMesEnCurso(){var e=(new Date).getMonth()+1;const a=document.querySelector("#idFecha");a.addEventListener(),a.value=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][e-1]}function busqueda(){const e=document.querySelector("#folioBusqueda"),a=document.querySelector("#fechaBusqueda"),t=document.querySelector("#atiendeBusqueda"),i=document.querySelector("#requiereBusqueda"),u=document.querySelector("#estadoBusqueda"),c=document.querySelector("#clasificacionBusqueda"),s=document.querySelector("#subclasificacionBusqueda"),o=document.querySelector("#servicioBusqueda");e.addEventListener("keyup",(function(){folioBusqueda=e.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),a.addEventListener("keyup",(function(){fechaBusqueda=a.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),t.addEventListener("keyup",(function(){atiendeBusqueda=t.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),i.addEventListener("keyup",(function(){requiereBusqueda=i.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),u.addEventListener("keyup",(function(){estadoBusqueda=u.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),c.addEventListener("keyup",(function(){clasificacionBusqueda=c.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),s.addEventListener("keyup",(function(){subclasificacionBusqueda=s.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),o.addEventListener("keyup",(function(){servicioBusqueda=o.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)}))}async function llenarTablaTickets(e,a,t,i,u,c,s,o,n,d,r,l){const q=document.querySelector(".tabla__body.tickets"),f=document.querySelector("#paginas");try{const b="/api/obtenerTablaTickets?page="+e+"&folio="+a+"&fecha="+String(t)+"&atiende="+i+"&requiere="+u+"&estado="+c+"&clasificacion="+s+"&subclasificacion="+o+"&rangoChecked="+n+"&fechaDesde="+d+"&fechaHasta="+r+"&servicio="+l,p=await fetch(b),B=await p.json(),m=B.tablaRows,g=B.total_registros,h=B.total_paginas,v=document.querySelector(".paginacion");v.style.visibility=0===h||1===h?"hidden":"visible";const y=B.idRol;expedienteLogueado=B.expediente_logueado;const k=B.nombreLogueado;pagina_siguiente=B.pagina_siguiente,pagina_anterior=B.pagina_anterior,html_siguiente=B.html_siguiente,g>total_registros_anterior&&(total_registros_anterior=g,paginaActual=1),q.innerHTML="",m.forEach(e=>{const a=document.createElement("tr"),t=document.createElement("td"),i=document.createElement("button"),u=document.createElement("td"),c=document.createElement("td"),s=document.createElement("td"),o=document.createElement("td"),n=document.createElement("p"),d=document.createElement("td"),r=document.createElement("td"),l=document.createElement("td"),b=document.createElement("td"),p=document.createElement("td"),B=document.createElement("td"),m=document.createElement("DIV"),{idTicket:g,fechaCaptura:v,atiende:S,nombreRequiere:L,estadoTicket:C,clasificacion:T,subclasificacion:x,comentarios:E,comentariosSoporte:A,tipoServicio:w}=e;console.log(S),i.textContent=g,i.setAttribute("value",g),i.setAttribute("data-folio",g),i.setAttribute("data-bs-toggle","modal"),i.setAttribute("data-bs-target","#infoModal"),u.textContent=v,c.textContent=S,s.textContent=L,n.textContent=C,d.textContent=T,r.textContent=x,l.textContent=E,b.textContent=A,p.textContent=w,t.classList.add("text-center"),i.classList.add("btn","btn-info","text-center","btnFolio","fs-4"),u.classList.add("text-center","fs-5"),c.classList.add("text-center","fs-5"),s.classList.add("text-center","fs-5"),o.classList.add("text-center","fs-5"),d.classList.add("text-center","fs-5"),r.classList.add("text-center","fs-5"),l.classList.add("text-center","fs-5"),b.classList.add("text-center","fs-5"),p.classList.add("text-center","fs-5"),B.classList.add("text-center","fs-5"),"Abierto"===C&&n.classList.add("text-white","bg-danger","bg-opacity-75","rounded-5","w-50","m-auto"),"Pausado"===C&&n.classList.add("text-white","bg-secondary","bg-opacity-75","rounded-5","w-50","m-auto"),"Escalado"===C&&n.classList.add("text-white","bg-warning","bg-opacity-75","rounded-5","w-50","m-auto"),"Cerrado"===C&&n.classList.add("text-white","bg-success","bg-opacity-75","rounded-5","w-50","m-auto"),o.appendChild(n),m.classList.add("container","d-flex","gap-2"),"4"===y&&m.classList.add("container","d-flex","gap-2"),m.innerHTML="<a href='/dashboard/historial-tickets?id="+g+"' title='Historial del ticket' class='fs-2 btn btn-primary btn-sm'><i class='bi bi-calendar2-week'></i></a>","2"===y&&("Abierto"===C||"Pausado"===C||"Escalado"===C?("Sin asignar"===S.trim()&&(m.innerHTML+="<a href='/dashboard/asignar-tickets?id="+g+"' title='Asignar ticket' class='fs-2 btn btn-info btn-sm'><i class='bi bi-person-up'></i></i></a>"),"Sin asignar"!==S.trim()&&(m.innerHTML+="<a href='/dashboard/pausar-tickets?id="+g+"' title='Pausar ticket' class='fs-2 btn btn-secondary btn-sm'><i class='bi bi-pause-circle'></i></a>",m.innerHTML+="<a href='/dashboard/escalar-tickets?id="+g+"' title='Escalar ticket' class='fs-2 btn btn-warning btn-sm'><i class='bi bi-bezier2'></i></a>",m.innerHTML+="<a href='/dashboard/cerrar-tickets?id="+g+"' title='Cerrar ticket' class='fs-2 btn btn-success btn-sm'><i class='bi bi-check2-circle'></i></a>")):m.innerHTML+="<p class='text-white bg-success bg-opacity-75 rounded-5 w-75 m-auto'>Ticket cerrado</p>"),"1"!==y&&"3"!==y||("Abierto"===C||"Pausado"===C||"Escalado"===C?"Sin asignar"!==S.trim()&&S.trim()===k&&(m.innerHTML+="<a href='/dashboard/pausar-tickets?id="+g+"' title='Pausar ticket' class='fs-2 btn btn-secondary btn-sm'><i class='bi bi-pause-circle'></i></a>","1"===y&&(m.innerHTML+="<a href='/dashboard/escalar-tickets?id="+g+"' title='Escalar ticket' class='fs-2 btn btn-warning btn-sm'><i class='bi bi-bezier2'></i></a>"),m.innerHTML+="<a href='/dashboard/cerrar-tickets?id="+g+"' title='Cerrar ticket' class='fs-2 btn btn-success btn-sm'><i class='bi bi-check2-circle'></i></a>"):m.innerHTML+="<p class='text-white bg-success bg-opacity-75 rounded-5 w-75 mx-auto m-auto'>Ticket cerrado</p>"),"4"===y&&"Cerrado"===C&&(m.innerHTML+="<p class='tabla__cerrado'>Ticket cerrado</p>"),t.appendChild(i),a.appendChild(t),a.appendChild(u),a.appendChild(c),a.appendChild(s),a.appendChild(o),a.appendChild(d),a.appendChild(r),a.appendChild(l),a.appendChild(b),a.appendChild(p),B.appendChild(m),a.appendChild(B),q.appendChild(a),btnSiguiente.disabled=!pagina_siguiente,btnAnterior.disabled=!pagina_anterior;var H="";var D=1,M=h;if(h<=5)D=1,M=h;else{const e=Math.floor(2.5);D=Math.max(1,paginaActual-e),(M=Math.min(h,D+5-1))-D+1<5&&(D=Math.max(1,M-5+1))}for(var _=D;_<=M;_++)H+="4485"===expedienteLogueado||"4486"===expedienteLogueado?' <button  class="btn btn-outline-dark fs-3 botonPaginas" data-pagina ='+_+">"+_+" </button>":' <button  class="btn btn-outline-primary fs-3 botonPaginas" data-pagina ='+_+">"+_+" </button>";f.innerHTML=H,console.log("inicio "+D+" fin "+M);document.querySelectorAll(".botonPaginas").forEach(e=>{e.addEventListener("click",(function(e){pagina=parseInt(e.target.dataset.pagina),llenarTablaTickets(paginaActual=pagina,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),parseInt(e.dataset.pagina)===parseInt(paginaActual)?"4485"===expedienteLogueado||"4486"===expedienteLogueado?(e.classList.remove("btn-outline-dark"),e.classList.add("btn-dark")):(e.classList.remove("btn-outline-primary"),e.classList.add("btn-primary")):"4485"===expedienteLogueado||"4486"===expedienteLogueado?(e.classList.add("btn-outline-dark"),e.classList.remove("btn-dark")):(e.classList.add("btn-outline-primary"),e.classList.remove("btn-primary"))})}),modal()}catch(e){console.log(e)}}function fadeOutAlerta(){$(".div-ver-tickets").fadeOut(1e3)}function paginas(){document.querySelectorAll(".botonPaginas").forEach(e=>{e.addEventListener("click",(function(e){console.log("memo")}))})}async function abrirModal(e){let a=document.querySelector("#infoModal");try{const t="/api/modal?folio="+e,i=await fetch(t),u=(await i.json()).infoTicket;a.addEventListener("shown.bs.modal",e=>{let t=a.querySelector(".modal-body #folio"),i=a.querySelector(".modal-body #estado"),c=a.querySelector(".modal-body #requiere"),s=a.querySelector(".modal-body #departamento"),o=a.querySelector(".modal-body #extension"),n=a.querySelector(".modal-body #email"),d=a.querySelector(".modal-body #clasificacion"),r=a.querySelector(".modal-body #subclasificacion"),l=a.querySelector(".modal-body #comentariosReporte"),q=a.querySelector(".modal-body #comentariosSoporte"),f=a.querySelector(".modal-body #tipoServicio"),b=a.querySelector(".modal-body #atiende");t.value=u.idTicket,c.value=u.nombreRequiere,s.value=u.departamento,o.value=u.extension,n.value=u.email,i.value=u.estadoTicket,d.value=u.clasificacion,r.value=u.subclasificacion,l.value=u.comentariosReporte,q.value=""===u.comentariosSoporte?"-":u.comentariosSoporte,f.value=u.tipoServicio,b.value=u.atiende})}catch(e){console.log(e)}}async function exportarExcel(e,a,t,i,u,c,s,o,n,d,r){try{const f="/api/exportarExcel?folio="+e+"&fecha="+String(a)+"&atiende="+t+"&requiere="+i+"&estado="+u+"&clasificacion="+c+"&subclasificacion="+s+"&rangoChecked="+o+"&fechaDesde="+n+"&fechaHasta="+d+"&servicio="+r,b=await fetch(f),p=(await b.json()).tablaRows;let B="Folio,Fecha de captura, Quien atiende, Quien requiere el servicio,Estado del ticket, Clasificacion, Subclasificacion, Comentarios del reporte, Comentarios de soporte,Servicio\n";p.forEach(e=>{let a=e.idTicket+","+e.fechaCaptura+","+String(e.atiende).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.nombreRequiere).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+e.estadoTicket+","+String(e.clasificacion).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.subclasificacion).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.comentarios).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.comentariosSoporte).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.tipoServicio).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+"\n";B+=a});var l=new Blob([B],{type:"text/csv"}),q=new Date;guardarExcel(l,"ReporteTickes"+(q.toLocaleString("default",{year:"numeric"})+"-"+q.toLocaleString("default",{month:"2-digit"})+"-"+q.toLocaleString("default",{day:"2-digit"}))+".csv")}catch(e){console.log(e)}}function guardarExcel(e,a){if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,a);else{const t=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.href=t,i.download=a,i.click(),setTimeout(()=>{window.URL.revokeObjectURL(t),document.body.removeChild(i)},0)}}setInterval((function(){llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)}),2e3),setTimeout((function(){fadeOutAlerta()}),2e3);