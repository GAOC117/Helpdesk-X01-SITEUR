var pagina_siguiente,pagina_anterior,html_siguiente,paginaActual=1,folioBusqueda="",fechaBusqueda="",clasificacionBusqueda="",subclasificacionBusqueda="",atiendeBusqueda="",requiereBusqueda="",estadoBusqueda="",rangoChecked=!1;const btnSiguiente=document.querySelector("#btnSiguiente"),btnAnterior=document.querySelector("#btnAnterior"),rangoCheck=document.querySelector("#checkFechas"),limpiarFiltros=document.querySelector("#limpiarFiltros");rangoCheck.addEventListener("change",(function(){rangoChecked=!!rangoCheck.checked,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)}));var folioModal,total_registros_anterior=0;function modal(){document.querySelectorAll(".btnFolio").forEach(e=>{e.addEventListener("click",(function(e){abrirModal(folioModal=parseInt(e.target.dataset.folio))}))})}function prueba(){}limpiarNotificaciones(),busqueda(),document.addEventListener("DOMContentLoaded",(function(){var e=new Date,a=e.toLocaleString("default",{year:"numeric"})+"-"+e.toLocaleString("default",{month:"2-digit"})+"-"+e.toLocaleString("default",{day:"2-digit"});const t=document.querySelector("#fechaDesde"),i=document.querySelector("#fechaHasta");t.value=a,i.value=a,t.addEventListener("change",(function(){llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value)})),i.addEventListener("change",(function(){llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value)})),limpiarFiltros.addEventListener("click",(function(){const e=document.querySelector("#folioBusqueda"),u=document.querySelector("#fechaBusqueda"),c=document.querySelector("#atiendeBusqueda"),n=document.querySelector("#requiereBusqueda"),s=document.querySelector("#estadoBusqueda"),o=document.querySelector("#clasificacionBusqueda"),d=document.querySelector("#subclasificacionBusqueda");e.value="",u.value="",c.value="",n.value="",s.value="",o.value="",d.value="",t.value=a,i.value=a,rangoCheck.checked=!1,llenarTablaTickets(paginaActual=1,folioBusqueda="",fechaBusqueda="",atiendeBusqueda="",requiereBusqueda="",estadoBusqueda="",clasificacionBusqueda="",subclasificacionBusqueda="",rangoChecked=!1,t.value,i.value)})),llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value),btnSiguiente.addEventListener("click",(function(){paginaActual<pagina_siguiente&&paginaActual++,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value)})),btnAnterior.addEventListener("click",(function(){paginaActual>=pagina_anterior&&paginaActual--,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value)}))}));const folio=document.querySelector("#idFolio"),atiende=document.querySelector("#idAtiende"),fecha=document.querySelector("#idFecha"),requiere=document.querySelector("#idRequiere"),estado=document.querySelector("#idEstado"),clasificacion=document.querySelector("#idClasificacion"),subclasificacion=document.querySelector("#idSubclasificacion"),comentarios=document.querySelector("#idComentarios"),comentariosSoporte=document.querySelector("#idComentariosSoporte");async function limpiarNotificaciones(){try{const e="/api/limpiarNotificaciones";await fetch(e)}catch(e){console.log(e)}}function mostrarMesEnCurso(){var e=(new Date).getMonth()+1;const a=document.querySelector("#idFecha");a.addEventListener(),a.value=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][e-1]}function busqueda(){const e=document.querySelector("#folioBusqueda"),a=document.querySelector("#fechaBusqueda"),t=document.querySelector("#atiendeBusqueda"),i=document.querySelector("#requiereBusqueda"),u=document.querySelector("#estadoBusqueda"),c=document.querySelector("#clasificacionBusqueda"),n=document.querySelector("#subclasificacionBusqueda");e.addEventListener("keyup",(function(){folioBusqueda=e.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)})),a.addEventListener("keyup",(function(){fechaBusqueda=a.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)})),t.addEventListener("keyup",(function(){atiendeBusqueda=t.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)})),i.addEventListener("keyup",(function(){requiereBusqueda=i.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)})),u.addEventListener("keyup",(function(){estadoBusqueda=u.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)})),c.addEventListener("keyup",(function(){clasificacionBusqueda=c.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)})),n.addEventListener("keyup",(function(){subclasificacionBusqueda=n.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)}))}async function llenarTablaTickets(e,a,t,i,u,c,n,s,o,d,l){const r=document.querySelector(".tabla__body.tickets"),q=document.querySelector("#paginas");try{const f="/api/obtenerTablaTickets?page="+e+"&folio="+a+"&fecha="+String(t)+"&atiende="+i+"&requiere="+u+"&estado="+c+"&clasificacion="+n+"&subclasificacion="+s+"&rangoChecked="+o+"&fechaDesde="+d+"&fechaHasta="+l,b=await fetch(f),B=await b.json(),m=B.tablaRows,g=B.total_registros,h=B.total_paginas,p=document.querySelector(".paginacion");p.style.visibility=0===h||1===h?"hidden":"visible";const v=B.idRol,y=B.nombreLogueado;pagina_siguiente=B.pagina_siguiente,pagina_anterior=B.pagina_anterior,html_siguiente=B.html_siguiente,g>total_registros_anterior&&(total_registros_anterior=g,paginaActual=1),r.innerHTML="",m.forEach(e=>{const a=document.createElement("tr"),t=document.createElement("td"),i=document.createElement("button"),u=document.createElement("td"),c=document.createElement("td"),n=document.createElement("td"),s=document.createElement("td"),o=document.createElement("p"),d=document.createElement("td"),l=document.createElement("td"),f=document.createElement("td"),b=document.createElement("td"),B=document.createElement("td"),m=document.createElement("DIV"),{idTicket:g,fechaCaptura:p,atiende:k,nombreRequiere:S,estadoTicket:L,clasificacion:T,subclasificacion:C,comentarios:A,comentariosSoporte:E}=e;i.textContent=g,i.setAttribute("value",g),i.setAttribute("data-folio",g),i.setAttribute("data-bs-toggle","modal"),i.setAttribute("data-bs-target","#infoModal"),u.textContent=p,c.textContent=k,n.textContent=S,o.textContent=L,d.textContent=T,l.textContent=C,f.textContent=A,b.textContent=E,t.classList.add("text-center"),i.classList.add("btn","btn-info","text-center","btnFolio","fs-4"),u.classList.add("tabla__td","text-center"),c.classList.add("tabla__td","text-center"),n.classList.add("tabla__td","text-center"),s.classList.add("tabla__td","text-center"),d.classList.add("tabla__td","text-center"),l.classList.add("tabla__td","text-center"),f.classList.add("tabla__td","text-center"),b.classList.add("tabla__td","text-center"),B.classList.add("tabla__td","text-center"),"Abierto"===L&&o.classList.add("text-white","bg-danger","bg-opacity-75","rounded-5","w-50","m-auto"),"Pausado"===L&&o.classList.add("text-white","bg-secondary","bg-opacity-75","rounded-5","w-50","m-auto"),"Escalado"===L&&o.classList.add("text-white","bg-warning","bg-opacity-75","rounded-5","w-50","m-auto"),"Cerrado"===L&&o.classList.add("text-white","bg-success","bg-opacity-75","rounded-5","w-50","m-auto"),s.appendChild(o),m.classList.add("container","d-flex","gap-2"),"4"===v&&m.classList.add("container","d-flex","gap-2"),m.innerHTML="<a href='/dashboard/historial-tickets?id="+g+"' title='Historial del ticket' class='fs-2 btn btn-primary btn-sm'><i class='bi bi-calendar2-week'></i></a>","2"===v&&("Abierto"===L||"Pausado"===L||"Escalado"===L?("Sin asignar"===k&&(m.innerHTML+="<a href='/dashboard/asignar-tickets?id="+g+"' title='Asignar ticket' class='fs-2 btn btn-info btn-sm'><i class='bi bi-person-up'></i></i></a>"),"Sin asignar"!==k&&(m.innerHTML+="<a href='/dashboard/pausar-tickets?id="+g+"' title='Pausar ticket' class='fs-2 btn btn-secondary btn-sm'><i class='bi bi-pause-circle'></i></a>",m.innerHTML+="<a href='/dashboard/escalar-tickets?id="+g+"' title='Escalar ticket' class='fs-2 btn btn-warning btn-sm'><i class='bi bi-bezier2'></i></a>",m.innerHTML+="<a href='/dashboard/cerrar-tickets?id="+g+"' title='Cerrar ticket' class='fs-2 btn btn-success btn-sm'><i class='bi bi-check2-circle'></i></a>")):m.innerHTML+="<p class='text-white bg-success bg-opacity-75 rounded-5 w-75 m-auto'>Ticket cerrado</p>"),"1"!==v&&"3"!==v||("Abierto"===L||"Pausado"===L||"Escalado"===L?"Sin asignar"!==k&&k===y&&(m.innerHTML+="<a href='/dashboard/pausar-tickets?id="+g+"' title='Pausar ticket' class='fs-2 btn btn-secondary btn-sm'><i class='bi bi-pause-circle'></i></a>","1"===v&&(m.innerHTML+="<a href='/dashboard/escalar-tickets?id="+g+"' title='Escalar ticket' class='fs-2 btn btn-warning btn-sm'><i class='bi bi-bezier2'></i></a>"),m.innerHTML+="<a href='/dashboard/cerrar-tickets?id="+g+"' title='Cerrar ticket' class='fs-2 btn btn-success btn-sm'><i class='bi bi-check2-circle'></i></a>"):m.innerHTML+="<p class='text-white bg-success bg-opacity-75 rounded-5 w-75 mx-auto m-auto'>Ticket cerrado</p>"),"4"===v&&"Cerrado"===L&&(m.innerHTML+="<p class='tabla__cerrado'>Ticket cerrado</p>"),t.appendChild(i),a.appendChild(t),a.appendChild(u),a.appendChild(c),a.appendChild(n),a.appendChild(s),a.appendChild(d),a.appendChild(l),a.appendChild(f),a.appendChild(b),B.appendChild(m),a.appendChild(B),r.appendChild(a),btnSiguiente.disabled=!pagina_siguiente,btnAnterior.disabled=!pagina_anterior;var _="";var x=1,H=h;if(h>5)if(paginaActual<=5)x=1,H=5;else if(paginaActual+2===h||paginaActual+2>h)x=h-4,H=h;else x=paginaActual-2,H=paginaActual+2;for(var w=x;w<=H;w++)_+=' <button  class="btn btn-outline-primary fs-3 botonPaginas" data-pagina ='+w+">"+w+" </button>";q.innerHTML=_;document.querySelectorAll(".botonPaginas").forEach(e=>{e.addEventListener("click",(function(e){pagina=parseInt(e.target.dataset.pagina),llenarTablaTickets(paginaActual=pagina,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)})),parseInt(e.dataset.pagina)===parseInt(paginaActual)?(e.classList.remove("btn-outline-primary"),e.classList.add("btn-primary")):(e.classList.add("btn-outline-primary"),e.classList.remove("btn-primary"))})}),modal()}catch(e){console.log(e)}}function fadeOutAlerta(){$(".div-ver-tickets").fadeOut(1e3)}function paginas(){document.querySelectorAll(".botonPaginas").forEach(e=>{e.addEventListener("click",(function(e){console.log("memo")}))})}async function abrirModal(e){let a=document.querySelector("#infoModal");try{const t="/api/modal?folio="+e,i=await fetch(t),u=(await i.json()).infoTicket;console.log(u),a.addEventListener("shown.bs.modal",e=>{let t=a.querySelector(".modal-body #folio"),i=a.querySelector(".modal-body #requiere"),c=a.querySelector(".modal-body #departamento"),n=a.querySelector(".modal-body #extension"),s=a.querySelector(".modal-body #email"),o=a.querySelector(".modal-body #clasificacion"),d=a.querySelector(".modal-body #subclasificacion"),l=a.querySelector(".modal-body #comentariosReporte"),r=a.querySelector(".modal-body #comentariosSoporte"),q=a.querySelector(".modal-body #atiende");t.value=u.idTicket,i.value=u.nombreRequiere,c.value=u.departamento,n.value=u.extension,s.value=u.email,o.value=u.clasificacion,d.value=u.subclasificacion,l.value=u.comentariosReporte,r.value=u.comentariosSoporte,q.value=u.atiende})}catch(e){console.log(e)}}setInterval((function(){llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value)}),2e3),setTimeout((function(){fadeOutAlerta()}),2e3);