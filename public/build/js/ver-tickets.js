var expedienteLogueado,pagina_siguiente,pagina_anterior,html_siguiente,paginaActual=1,folioBusqueda="",fechaBusqueda="",clasificacionBusqueda="",subclasificacionBusqueda="",atiendeBusqueda="",requiereBusqueda="",estadoBusqueda="",servicioBusqueda="",rangoChecked=!1;const btnSiguiente=document.querySelector("#btnSiguiente"),btnAnterior=document.querySelector("#btnAnterior"),rangoCheck=document.querySelector("#checkFechas"),limpiarFiltros=document.querySelector("#limpiarFiltros"),excel=document.querySelector("#exportarExcel");excel.addEventListener("click",(function(){exportarExcel(folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),rangoCheck.addEventListener("change",(function(){rangoChecked=!!rangoCheck.checked,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)}));var folioModal,total_registros_anterior=0;function modal(){document.querySelectorAll(".btnFolio").forEach(e=>{e.addEventListener("click",(function(e){abrirModal(folioModal=parseInt(e.target.dataset.folio))}))})}function prueba(){}limpiarNotificaciones(),busqueda(),document.addEventListener("DOMContentLoaded",(function(){var e=new Date,a=e.toLocaleString("default",{year:"numeric"})+"-"+e.toLocaleString("default",{month:"2-digit"})+"-"+e.toLocaleString("default",{day:"2-digit"});const t=document.querySelector("#fechaDesde"),i=document.querySelector("#fechaHasta");t.value=a,i.value=a,t.addEventListener("change",(function(){llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda)})),i.addEventListener("change",(function(){llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda)})),limpiarFiltros.addEventListener("click",(function(){const e=document.querySelector("#folioBusqueda"),o=document.querySelector("#fechaBusqueda"),c=document.querySelector("#atiendeBusqueda"),u=document.querySelector("#requiereBusqueda"),n=document.querySelector("#estadoBusqueda"),s=document.querySelector("#clasificacionBusqueda"),d=document.querySelector("#subclasificacionBusqueda"),r=document.querySelector("#servicioBusqueda");e.value="",o.value="",c.value="",u.value="",n.value="",s.value="",d.value="",t.value=a,i.value=a,rangoCheck.checked=!1,r.value="",servicioBusqueda="",llenarTablaTickets(paginaActual=1,folioBusqueda="",fechaBusqueda="",atiendeBusqueda="",requiereBusqueda="",estadoBusqueda="",clasificacionBusqueda="",subclasificacionBusqueda="",rangoChecked=!1,t.value,i.value,servicioBusqueda)})),llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda),btnSiguiente.addEventListener("click",(function(){paginaActual<pagina_siguiente&&paginaActual++,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda)})),btnAnterior.addEventListener("click",(function(){paginaActual>=pagina_anterior&&paginaActual--,llenarTablaTickets(paginaActual,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,t.value,i.value,servicioBusqueda)}))}));const folio=document.querySelector("#idFolio"),atiende=document.querySelector("#idAtiende"),fecha=document.querySelector("#idFecha"),requiere=document.querySelector("#idRequiere"),estado=document.querySelector("#idEstado"),clasificacion=document.querySelector("#idClasificacion"),subclasificacion=document.querySelector("#idSubclasificacion"),comentarios=document.querySelector("#idComentarios"),comentariosSoporte=document.querySelector("#idComentariosSoporte");async function limpiarNotificaciones(){try{const e="/api/limpiarNotificaciones";await fetch(e)}catch(e){console.log(e)}}function mostrarMesEnCurso(){var e=(new Date).getMonth()+1;const a=document.querySelector("#idFecha");a.addEventListener(),a.value=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][e-1]}function busqueda(){const e=document.querySelector("#folioBusqueda"),a=document.querySelector("#fechaBusqueda"),t=document.querySelector("#atiendeBusqueda"),i=document.querySelector("#requiereBusqueda"),o=document.querySelector("#estadoBusqueda"),c=document.querySelector("#clasificacionBusqueda"),u=document.querySelector("#subclasificacionBusqueda"),n=document.querySelector("#servicioBusqueda");e.addEventListener("keyup",(function(){folioBusqueda=e.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),a.addEventListener("keyup",(function(){fechaBusqueda=a.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),t.addEventListener("keyup",(function(){atiendeBusqueda=t.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),i.addEventListener("keyup",(function(){requiereBusqueda=i.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),o.addEventListener("keyup",(function(){estadoBusqueda=o.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),c.addEventListener("keyup",(function(){clasificacionBusqueda=c.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),u.addEventListener("keyup",(function(){subclasificacionBusqueda=u.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),n.addEventListener("keyup",(function(){servicioBusqueda=n.value,llenarTablaTickets(paginaActual=1,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)}))}async function llenarTablaTickets(e,a,t,i,o,c,u,n,s,d,r,l){const q=document.querySelector(".tabla__body.tickets"),f=document.querySelector("#paginas");try{const m="/api/obtenerTablaTickets?page="+e+"&folio="+a+"&fecha="+String(t)+"&atiende="+i+"&requiere="+o+"&estado="+c+"&clasificacion="+u+"&subclasificacion="+n+"&rangoChecked="+s+"&fechaDesde="+d+"&fechaHasta="+r+"&servicio="+l,b=await fetch(m),p=await b.json(),g=p.tablaRows,B=p.total_registros,h=p.total_paginas,v=document.querySelector(".paginacion");v.style.visibility=0===h||1===h?"hidden":"visible";const y=p.idRol;expedienteLogueado=p.expediente_logueado;const k=p.nombreLogueado;pagina_siguiente=p.pagina_siguiente,pagina_anterior=p.pagina_anterior,html_siguiente=p.html_siguiente,B>total_registros_anterior&&(total_registros_anterior=B,paginaActual=1),q.innerHTML="",g.forEach(e=>{const a=document.createElement("tr"),t=document.createElement("td"),i=document.createElement("button"),o=document.createElement("td"),c=document.createElement("td"),u=document.createElement("td"),n=document.createElement("td"),s=document.createElement("p"),d=document.createElement("td"),r=document.createElement("td"),l=document.createElement("td"),m=document.createElement("td"),b=document.createElement("td"),p=document.createElement("td"),g=document.createElement("DIV"),{idTicket:B,fechaCaptura:v,atiende:S,nombreRequiere:L,estadoTicket:C,clasificacion:T,subclasificacion:x,comentarios:E,comentariosSoporte:A,tipoServicio:w}=e;i.textContent=B,i.setAttribute("value",B),i.setAttribute("data-folio",B),i.setAttribute("data-bs-toggle","modal"),i.setAttribute("data-bs-target","#infoModal"),o.textContent=v,c.textContent=S,u.textContent=L,s.textContent=C,d.textContent=T,r.textContent=x,l.textContent=E,m.textContent=A,b.textContent=w,t.classList.add("text-center"),i.classList.add("btn","btn-info","text-center","btnFolio","fs-4"),o.classList.add("text-center","fs-5"),c.classList.add("text-center","fs-5"),u.classList.add("text-center","fs-5"),n.classList.add("text-center","fs-5"),d.classList.add("text-center","fs-5"),r.classList.add("text-center","fs-5"),l.classList.add("text-center","fs-5"),m.classList.add("text-center","fs-5"),b.classList.add("text-center","fs-5"),p.classList.add("text-center","fs-5"),"Abierto"===C&&s.classList.add("text-white","bg-danger","bg-opacity-75","rounded-5","m-auto"),"Pausado"===C&&s.classList.add("text-white","bg-secondary","bg-opacity-75","rounded-5","m-auto"),"Escalado"===C&&s.classList.add("text-white","bg-warning","bg-opacity-75","rounded-5","m-auto"),"Cerrado"===C&&s.classList.add("text-white","bg-success","bg-opacity-75","rounded-5","m-auto"),n.appendChild(s),g.classList.add("container","d-flex","gap-2","acciones-header","justify-content-center"),"4"===y&&g.classList.add("container","d-flex","gap-2"),g.innerHTML="<a href='/dashboard/historial-tickets?id="+B+"' title='Historial del ticket' class='fs-2 btn btn-primary btn-sm'><i class='bi bi-calendar2-week'></i></a>","2"===y&&("Abierto"===C||"Pausado"===C||"Escalado"===C?("Sin asignar"===S.trim()&&(g.innerHTML+="<a href='/dashboard/asignar-tickets?id="+B+"' title='Asignar ticket' class='fs-2 btn btn-info btn-sm'><i class='bi bi-person-up'></i></i></a>"),"Sin asignar"!==S.trim()&&(g.innerHTML+="<a href='/dashboard/pausar-tickets?id="+B+"' title='Pausar ticket' class='fs-2 btn btn-secondary btn-sm'><i class='bi bi-pause-circle'></i></a>",g.innerHTML+="<a href='/dashboard/escalar-tickets?id="+B+"' title='Escalar ticket' class='fs-2 btn btn-warning btn-sm'><i class='bi bi-bezier2'></i></a>",g.innerHTML+="<a href='/dashboard/cerrar-tickets?id="+B+"' title='Cerrar ticket' class='fs-2 btn btn-success btn-sm'><i class='bi bi-check2-circle'></i></a>")):g.innerHTML+="<p class='text-white px-5 bg-success bg-opacity-75 rounded-5  m-auto'>Ticket cerrado</p>"),"1"!==y&&"3"!==y||("Abierto"===C||"Pausado"===C||"Escalado"===C?"Sin asignar"!==S.trim()&&S.trim()===k&&(g.innerHTML+="<a href='/dashboard/pausar-tickets?id="+B+"' title='Pausar ticket' class='fs-2 btn btn-secondary btn-sm'><i class='bi bi-pause-circle'></i></a>",g.innerHTML+="<a href='/dashboard/cerrar-tickets?id="+B+"' title='Cerrar ticket' class='fs-2 btn btn-success btn-sm'><i class='bi bi-check2-circle'></i></a>"):g.innerHTML+="<p class='text-white px-5 bg-success bg-opacity-75 rounded-5 mx-auto m-auto'>Ticket cerrado</p>"),"4"===y&&"Cerrado"===C&&(g.innerHTML+="<p class='tabla__cerrado  px-5'>Ticket cerrado</p>"),t.appendChild(i),a.appendChild(t),a.appendChild(o),a.appendChild(c),a.appendChild(u),a.appendChild(n),a.appendChild(d),a.appendChild(r),a.appendChild(l),a.appendChild(m),a.appendChild(b),p.appendChild(g),a.appendChild(p),q.appendChild(a),btnSiguiente.disabled=!pagina_siguiente,btnAnterior.disabled=!pagina_anterior;var M="";var H=1,D=h;if(h<=5)H=1,D=h;else{const e=Math.floor(2.5);H=Math.max(1,paginaActual-e),(D=Math.min(h,H+5-1))-H+1<5&&(H=Math.max(1,D-5+1))}for(var _=H;_<=D;_++)M+="4485"===expedienteLogueado||"4486"===expedienteLogueado?' <button  class="btn btn-outline-dark fs-3 botonPaginas" data-pagina ='+_+">"+_+" </button>":' <button  class="btn btn-outline-primary fs-3 botonPaginas" data-pagina ='+_+">"+_+" </button>";f.innerHTML=M;document.querySelectorAll(".botonPaginas").forEach(e=>{e.addEventListener("click",(function(e){pagina=parseInt(e.target.dataset.pagina),llenarTablaTickets(paginaActual=pagina,folioBusqueda,fechaBusqueda,atiendeBusqueda,requiereBusqueda,estadoBusqueda,clasificacionBusqueda,subclasificacionBusqueda,rangoChecked,fechaDesde.value,fechaHasta.value,servicioBusqueda)})),parseInt(e.dataset.pagina)===parseInt(paginaActual)?"4485"===expedienteLogueado||"4486"===expedienteLogueado?(e.classList.remove("btn-outline-dark"),e.classList.add("btn-dark")):(e.classList.remove("btn-outline-primary"),e.classList.add("btn-primary")):"4485"===expedienteLogueado||"4486"===expedienteLogueado?(e.classList.add("btn-outline-dark"),e.classList.remove("btn-dark")):(e.classList.add("btn-outline-primary"),e.classList.remove("btn-primary"))})}),modal()}catch(e){console.log(e)}}function fadeOutAlerta(){$(".div-ver-tickets").fadeOut(1e3)}function paginas(){document.querySelectorAll(".botonPaginas").forEach(e=>{e.addEventListener("click",(function(e){console.log("memo")}))})}setInterval((function(){}),2e3),setTimeout((function(){fadeOutAlerta()}),2e3);const modalInfoTicketCerrar=document.querySelector("#infoModal");async function abrirModal(e){let a=document.querySelector("#infoModal");try{const t="/api/modal?folio="+e,i=await fetch(t),o=(await i.json()).infoTicket;a.addEventListener("shown.bs.modal",e=>{let t=a.querySelector(".modal-body #folio"),i=a.querySelector(".modal-body #estado"),c=a.querySelector(".modal-body #requiere"),u=a.querySelector(".modal-body #departamento"),n=a.querySelector(".modal-body #extension"),s=a.querySelector(".modal-body #email"),d=a.querySelector(".modal-body #clasificacion"),r=a.querySelector(".modal-body #subclasificacion"),l=a.querySelector(".modal-body #comentariosReporte"),q=a.querySelector(".modal-body #comentariosSoporte"),f=a.querySelector(".modal-body #tipoServicio"),m=a.querySelector(".modal-body #atiende"),b=document.querySelector("#imgRequiere"),p=document.querySelector("#imgAtiende");t.value=o.idTicket,c.innerHTML=o.nombreRequiere,u.value=o.departamento,n.value=o.extension,s.value=o.email,i.value=o.estadoTicket,d.value=o.clasificacion,r.value=o.subclasificacion,l.value=o.comentariosReporte,q.value=""===o.comentariosSoporte?"-":o.comentariosSoporte,f.value=o.tipoServicio,m.innerHTML=o.atiende;const g=document.createElement("IMG"),B=document.createElement("IMG");g.src="http://skynet.siteur.gob.mx/fotos/"+o.expRequiere+".jpg",B.src="http://skynet.siteur.gob.mx/fotos/"+o.expAtiende+".jpg",g.classList.add("img-fluid","accordion-body"),B.classList.add("img-fluid","accordion-body"),g.alt="imagen empleado",B.alt="imagen empleado",b&&(b.textContent=""),p&&(p.textContent=""),b.appendChild(g),p.appendChild(B),console.log("y aqui? :')")})}catch(e){console.log(e)}}async function exportarExcel(e,a,t,i,o,c,u,n,s,d,r){try{const f="/api/exportarExcel?folio="+e+"&fecha="+String(a)+"&atiende="+t+"&requiere="+i+"&estado="+o+"&clasificacion="+c+"&subclasificacion="+u+"&rangoChecked="+n+"&fechaDesde="+s+"&fechaHasta="+d+"&servicio="+r,m=await fetch(f),b=(await m.json()).tablaRows;let p="Folio,Fecha de captura, Quien atiende, Quien requiere el servicio,Estado del ticket, Clasificacion, Subclasificacion, Comentarios del reporte, Comentarios de soporte,Servicio\n";b.forEach(e=>{let a=e.idTicket+","+e.fechaCaptura+","+String(e.atiende).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.nombreRequiere).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+e.estadoTicket+","+String(e.clasificacion).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.subclasificacion).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.comentarios).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.comentariosSoporte).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+","+String(e.tipoServicio).replace(",",";").normalize("NFD").replace(/[\u0300-\u036f]/g,"")+"\n";p+=a});var l=new Blob([p],{type:"text/csv"}),q=new Date;guardarExcel(l,"ReporteTickes"+(q.toLocaleString("default",{year:"numeric"})+"-"+q.toLocaleString("default",{month:"2-digit"})+"-"+q.toLocaleString("default",{day:"2-digit"}))+".csv")}catch(e){console.log(e)}}function guardarExcel(e,a){if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,a);else{const t=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.href=t,i.download=a,i.click(),setTimeout(()=>{window.URL.revokeObjectURL(t),document.body.removeChild(i)},0)}}modalInfoTicketCerrar.addEventListener("hidden.bs.modal",e=>{let a=modalInfoTicketCerrar.querySelector(".modal-body #folio"),t=modalInfoTicketCerrar.querySelector(".modal-body #estado"),i=modalInfoTicketCerrar.querySelector(".modal-body #requiere"),o=modalInfoTicketCerrar.querySelector(".modal-body #departamento"),c=modalInfoTicketCerrar.querySelector(".modal-body #extension"),u=modalInfoTicketCerrar.querySelector(".modal-body #email"),n=modalInfoTicketCerrar.querySelector(".modal-body #clasificacion"),s=modalInfoTicketCerrar.querySelector(".modal-body #subclasificacion"),d=modalInfoTicketCerrar.querySelector(".modal-body #comentariosReporte"),r=modalInfoTicketCerrar.querySelector(".modal-body #comentariosSoporte"),l=modalInfoTicketCerrar.querySelector(".modal-body #tipoServicio"),q=modalInfoTicketCerrar.querySelector(".modal-body #atiende"),f=document.querySelector("#imgRequiere"),m=document.querySelector("#imgAtiende"),b=document.querySelector(".empRequiere"),p=document.querySelector(".empAtiende");a.value="",i.innerHTML="",o.value="",c.value="",u.value="",t.value="",n.value="",s.value="",d.value="",r.value="",l.value="",q.innerHTML="",f.textContent="",m.textContent="",b.classList.remove("show"),p.classList.remove("show")});